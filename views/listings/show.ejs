<% layout("/layouts/boilerplate") %>

<script>
  const listing = <%- JSON.stringify(listing) %>;
</script>

<div class="row">
  <div class="col-lg-8 col-md-10 col-sm-12 mx-auto">

    <!-- TITLE -->
    <h3 class="mt-3"><%= listing.title %></h3>

    <!-- IMAGE -->
    <div class="card mt-3">
      <img
        src="<%= listing.image?.url || '/images/default.jpg' %>"
        class="card-img-top"
        alt="listing image"
      >

      <div class="card-body">

        <!-- HOST -->
        <p>
          <b>Hosted By:</b>
          <i>
            <%= listing.owner?.username || "WanderLust Host" %>
          </i>
        </p>

        <!-- DESCRIPTION -->
        <p><b>Description:</b> <%= listing.description %></p>

        <!-- PRICE -->
        <p>
          <b>Cost:</b>
          ₹<%= Number(listing.price).toLocaleString("en-IN") %>
        </p>

        <!-- CATEGORY -->
        <p>
          <b>Category:</b>
          <%= listing.category?.toLowerCase() || "general" %>
        </p>

        <!-- LOCATION -->
        <p>
          <b>Location:</b>
          <i class="fa-solid fa-location-dot"></i>
          <%= listing.location || "Unknown location" %>
        </p>

        <!-- COUNTRY -->
        <p>
          <b>Country:</b>
          <i class="fa-solid fa-globe"></i>
          <%= listing.country || "Unknown country" %>
        </p>
      </div>
    </div>

    <!-- RESERVE BUTTON -->
<div class="text-center mt-4">
  <button
    id="reserveBtn"
    class="btn btn-success"
    data-amount="<%= Math.round(Number(listing.price) * 0.5 * 100) %>"
    onclick="payNow(this)">
    Reserve (Pay ₹<%= Math.round(Number(listing.price) * 0.5) %> – Non-Refundable)
  </button>
</div>


    <hr>

    <!-- REVIEWS -->
    <% if (listing.reviews && listing.reviews.length > 0) { %>
      <h4 class="mt-4">Reviews</h4>

      <div class="row">
        <% for (let review of listing.reviews) { %>
          <div class="col-md-6 mt-3">
            <div class="card">
              <div class="card-body">
                <h6>
                  <i class="fa-solid fa-user"></i>
                  <%= review.author?.username || "User" %>
                </h6>
                <p>⭐ <%= review.rating %>/5</p>
                <p><%= review.comment %></p>
              </div>
            </div>
          </div>
        <% } %>
      </div>
    <% } %>

    <hr>

    <!-- MAP -->
    <h4 class="mt-4">Where you’ll be</h4>
    <p>
      <%= listing.location %>, <%= listing.country %>
    </p>
    <div id="map" style="height: 400px;"></div>

  </div>
</div>

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

<script>
  function payNow(btn) {
    const amountInPaise = Number(btn.dataset.amount);

    console.log("Amount in paise:", amountInPaise);

    // HARD VALIDATION (IMPORTANT)
    if (!amountInPaise || amountInPaise < 100) {
      alert("Invalid payment amount. Please refresh the page.");
      return;
    }

    const options = {
      key: "<%= process.env.RAZORPAY_KEY_ID %>",
      amount: amountInPaise, // ✅ INTEGER IN PAISE
      currency: "INR",
      name: "WanderLust",
      description: "50% Advance (Non-Refundable)",
      handler: function (response) {
        alert("Payment Successful!");
        console.log(response);

        // disable button after success
        btn.disabled = true;
        btn.innerText = "Reserved";
      },
      theme: {
        color: "#16a34a",
      },
    };

    const rzp = new Razorpay(options);
    rzp.open();
  }
</script>


<!-- MAP SCRIPT -->
<script src="/js/map.js"></script>
